sudo: false
language: python
cache:
  directories:
  - "$HOME/google-cloud-sdk/"
env:
- PATH=$PATH:${HOME}/google-cloud-sdk/bin CLOUDSDK_CORE_DISABLE_PROMPTS=1 GOOGLE_APPLICATION_CREDENTIALS="credentials.json"
before_install:
- openssl aes-256-cbc -K $encrypted_e2c84e1c574e_key -iv $encrypted_e2c84e1c574e_iv
  -in credentials.json.enc -out credentials.json -d
- if [ ! -d ${HOME}/google-cloud-sdk ]; then curl https://sdk.cloud.google.com | bash;
  fi
- gcloud auth activate-service-account --key-file credentials.json
install:
- pip install ansible
- wget https://releases.hashicorp.com/packer/1.1.3/packer_1.1.3_linux_amd64.zip
- unzip packer_1.1.3_linux_amd64.zip
script:
- packer build -var 'proj_id=docker-181710' -var 's_im_fam=ubuntu-1604-lts' ubuntu16.json
- export IMAGE=`jq -r '.builds[0].artifact_id' output.json`
- echo $IMAGE
- gcloud compute instances create "travis-reddit-app" --image "$IMAGE" --zone "europe-west1-b" --project docker-181710
- export EXTERNAL_IP=`gcloud compute instances list --filter="name=travis-reddit-app" --format='value(EXTERNAL_IP)' --project docker-181710`
- echo $EXTERNAL_IP
- ansible-playbook -u root -i "$EXTERNAL_IP," packer_deploy.yml